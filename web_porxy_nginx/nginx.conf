worker_processes 1;
events { worker_connections 1024; }

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    # ‡πÉ‡∏ä‡πâ DNS Docker (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ Dynamic)
    resolver 127.0.0.11 valid=10s ipv6=off;

    server {
        listen 8080;

        # 1. ‡∏´‡∏ô‡πâ‡∏≤ Dashboard (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        location / {
            root /var/www/dashboard;
            index index.html;
            try_files $uri $uri/ /index.html;
        }

        # 2. Block ‡∏°‡∏´‡∏±‡∏®‡∏à‡∏£‡∏£‡∏¢‡πå (Dynamic Proxy)
        # ‡∏à‡∏±‡∏ö Pattern: /proxy/<‡πÄ‡∏•‡∏Ç‡∏û‡∏≠‡∏£‡πå‡∏ï>/<path‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠>
# nginx.conf

        location ~ ^/proxy/(?<target_port>\d+)/(?<target_path>.*)$ {
            
            set $upstream_host "127.0.0.1";
            proxy_pass http://$upstream_host:$target_port/$target_path$is_args$args;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;

            # --- ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Path (‡πÄ‡∏î‡∏¥‡∏°) ---
            proxy_redirect ~^/(.*) /proxy/$target_port/$1;
            proxy_cookie_path / /proxy/$target_port/;

            # ==================================================
            # üî• ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ "refused to connect" üî•
            # ==================================================
            
            # 1. ‡∏•‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á Jupyter/Hawtio ‡∏ó‡∏¥‡πâ‡∏á‡∏ã‡∏∞
            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
            
            # 2. (Optional) ‡πÉ‡∏™‡πà Header ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ó‡∏±‡∏ö‡∏•‡∏á‡πÑ‡∏õ‡πÅ‡∏ó‡∏ô
            add_header X-Frame-Options "SAMEORIGIN";
            # ==================================================

            proxy_intercept_errors on;
            error_page 502 = @backend_down;
        }
    }
}