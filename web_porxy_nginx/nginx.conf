worker_processes 1;
events { worker_connections 1024; }

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    # ‡πÉ‡∏ä‡πâ DNS Docker (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ Dynamic)
    resolver 127.0.0.11 valid=10s ipv6=off;

    server {
        listen 8080;

        # 1. ‡∏´‡∏ô‡πâ‡∏≤ Dashboard (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        location / {
            root /var/www/dashboard;
            index index.html;
            try_files $uri $uri/ /index.html;
        }

        # 2. Block ‡∏°‡∏´‡∏±‡∏®‡∏à‡∏£‡∏£‡∏¢‡πå (Dynamic Proxy)
        # ‡∏à‡∏±‡∏ö Pattern: /proxy/<‡πÄ‡∏•‡∏Ç‡∏û‡∏≠‡∏£‡πå‡∏ï>/<path‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠>
# nginx.conf

# ----------------------------- Block ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Jupyter (‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏Å‡∏ß‡πà‡∏≤ Regex) -------------------------------
        location /jupyter/ {
            # ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà 127.0.0.1:8888/jupyter/ (Path ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß)
            proxy_pass http://127.0.0.1:8888;
            
            # --- üî• WebSocket Support (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Jupyter) üî• ---
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            # Header ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Refused to connect (‡∏•‡∏ö Header ‡∏´‡πâ‡∏≤‡∏° iframe)
            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
        }

# ---------------------------------- Block ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Hawtio (ODL) -------------------------------------
# 1. Block ‡∏´‡∏•‡∏±‡∏Å (‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ó‡∏±‡πâ‡∏á /jvm, /osgi, /runtime ‡∏Ø‡∏•‡∏Ø)
        location /hawtio/ {
            # proxy_pass http://127.0.0.1:8181/hawtio/;
            proxy_pass http://127.0.0.1:8181/hawtio/auth/login;

            
            # Header ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # ‡πÅ‡∏Å‡πâ Cookie/Redirect
            proxy_cookie_path /hawtio /hawtio;
            proxy_redirect default;

            # üî• ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô iFrame
            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
        }

        # 2. Block ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ JVM/OSGi)
        location /jolokia/ {
            proxy_pass http://127.0.0.1:8181/jolokia/;
            proxy_set_header Authorization $http_authorization;
            proxy_set_header Host $host;
            proxy_set_header Origin "http://127.0.0.1:8181";
            
            # ‡∏•‡∏ö Header ‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß
            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
            proxy_hide_header Origin;
        }

        # 3. Block Login
        location /auth/ {
            proxy_pass http://127.0.0.1:8181/auth/;
            proxy_set_header Host $host;
        }

# -----------------------------------------------------------------------------------
        # ... (Block Regex ‡πÄ‡∏î‡∏¥‡∏° /proxy/... ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Service ‡∏≠‡∏∑‡πà‡∏ô‡πÜ) ...
        location ~ ^/proxy/(?<target_port>\d+)/(?<target_path>.*)$ {
            
            set $upstream_host "127.0.0.1";
            proxy_pass http://$upstream_host:$target_port/$target_path$is_args$args;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;

            # --- ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Path (‡πÄ‡∏î‡∏¥‡∏°) ---
            proxy_redirect ~^/(.*) /proxy/$target_port/$1;
            proxy_cookie_path / /proxy/$target_port/;

            # ==================================================
            # üî• ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ "refused to connect" üî•
            # ==================================================
            
            # 1. ‡∏•‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á Jupyter/Hawtio ‡∏ó‡∏¥‡πâ‡∏á‡∏ã‡∏∞
            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
            
            # 2. (Optional) ‡πÉ‡∏™‡πà Header ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ó‡∏±‡∏ö‡∏•‡∏á‡πÑ‡∏õ‡πÅ‡∏ó‡∏ô
            add_header X-Frame-Options "SAMEORIGIN";
            # ==================================================

            proxy_intercept_errors on;
            error_page 502 = @backend_down;
        }
    }
}